{% extends "base.html" %}

{% block title %}聊天 - 豆包AI聊天{% endblock %}

{% block styles %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
    }
    
    .chat-sidebar {
        width: 280px;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
    }
    
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }
    
    .chat-input {
        padding: 15px;
        border-top: 1px solid #dee2e6;
    }
    
    .chat-bubble {
        max-width: 80%;
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 18px;
        position: relative;
    }
    
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 5px;
    }
    
    .assistant-message {
        background-color: #f1f1f1;
        color: #333;
        margin-right: auto;
        border-bottom-left-radius: 5px;
    }
    
    .chat-item {
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
    }
    
    .chat-item:hover {
        background-color: #f8f9fa;
    }
    
    .chat-item.active {
        background-color: #e9ecef;
    }
    
    .chat-item-title {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .chat-item-time {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .new-chat-btn {
        margin: 15px;
    }
    
    .message-time {
        font-size: 0.7rem;
        margin-top: 5px;
        opacity: 0.7;
    }
    
    .typing-indicator {
        display: none;
        padding: 10px 15px;
        background-color: #f1f1f1;
        border-radius: 18px;
        margin-bottom: 15px;
        width: fit-content;
    }
    
    .typing-indicator span {
        height: 10px;
        width: 10px;
        float: left;
        margin: 0 1px;
        background-color: #9E9EA1;
        display: block;
        border-radius: 50%;
        opacity: 0.4;
    }
    
    .typing-indicator span:nth-of-type(1) {
        animation: 1s blink infinite 0.3333s;
    }
    
    .typing-indicator span:nth-of-type(2) {
        animation: 1s blink infinite 0.6666s;
    }
    
    .typing-indicator span:nth-of-type(3) {
        animation: 1s blink infinite 0.9999s;
    }
    
    .typing-indicator .timeout-message {
        display: none;
        margin-left: 20px;
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    @keyframes blink {
        50% {
            opacity: 1;
        }
    }
    
    .chat-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
    }
    
    .chat-empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
        .chat-sidebar {
            width: 100%;
            position: fixed;
            top: 56px;
            left: 0;
            height: calc(100vh - 56px);
            z-index: 1000;
            background-color: white;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .chat-sidebar.show {
            transform: translateX(0);
        }
        
        .toggle-sidebar {
            display: block !important;
        }
    }
    
    .model-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        margin-left: 0.5rem;
    }
    
    .model-badge-openai {
        background-color: #10a37f;
        color: white;
    }
    
    .model-badge-deepseek {
        background-color: #4361ee;
        color: white;
    }
    
    .model-badge-siliconflow {
        background-color: #ff6b6b;
        color: white;
    }
    
    .model-badge-custom {
        background-color: #9775fa;
        color: white;
    }
    
    .model-switcher {
        position: relative;
        margin-left: 0.5rem;
    }
    
    .model-switch-btn {
        padding: 0.1rem 0.3rem;
        margin-left: 0.25rem;
        border-radius: 0.25rem;
        color: #6c757d;
    }
    
    .model-switch-btn:hover {
        background-color: rgba(108, 117, 125, 0.1);
        color: #495057;
    }
    
    .model-switch-menu {
        min-width: 10rem;
        padding: 0.5rem 0;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .model-switch-menu .dropdown-item {
        padding: 0.5rem 1rem;
    }
    
    .model-switch-menu .dropdown-item.active {
        background-color: #f8f9fa;
        color: #212529;
    }
    
    .model-switch-menu .dropdown-item:hover {
        background-color: #f1f3f5;
    }
    
    .btn-primary:active, .btn-primary.active {
        transform: scale(0.95);
        transition: transform 0.1s;
    }
    
    .send-button-flash {
        animation: sendButtonFlash 0.3s;
    }
    
    @keyframes sendButtonFlash {
        0% { background-color: #007bff; }
        50% { background-color: #0056b3; }
        100% { background-color: #007bff; }
    }
    
    /* Markdown Styling */
    .assistant-message {
        line-height: 1.6;
    }
    
    .assistant-message p {
        margin-bottom: 12px;
    }
    
    .assistant-message pre {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
        margin: 12px 0;
        border: 1px solid #e9ecef;
    }
    
    .assistant-message code {
        font-family: 'Courier New', Courier, monospace;
        background-color: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 0.9em;
    }
    
    .assistant-message .inline-code {
        background-color: rgba(175, 184, 193, 0.2);
        padding: 0.2em 0.4em;
        border-radius: 6px;
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
        font-size: 85%;
    }
    
    .assistant-message .code-block {
        background-color: #f6f8fa;
        border-radius: 6px;
        margin-bottom: 16px;
        padding: 16px;
        border: 1px solid #d0d7de;
    }
    
    .assistant-message ul, .assistant-message ol {
        padding-left: 20px;
        margin: 12px 0;
    }
    
    .assistant-message li {
        margin-bottom: 6px;
    }
    
    .assistant-message h3, 
    .assistant-message h4, 
    .assistant-message h5 {
        margin-top: 20px;
        margin-bottom: 10px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Sidebar with chat history -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="d-grid gap-2 new-chat-btn">
            <button class="btn btn-primary" id="newChatBtn">
                <i class="fas fa-plus me-2"></i>新对话
            </button>
        </div>
        
        <div class="chat-list">
            {% for chat in chats %}
            <div class="chat-item {% if chat.id == active_chat.id %}active{% endif %}" data-chat-id="{{ chat.id }}">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="chat-item-title">{{ chat.title }}</div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-link text-muted chat-options" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item rename-chat" href="#" data-chat-id="{{ chat.id }}">重命名</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-chat" href="#" data-chat-id="{{ chat.id }}">删除</a></li>
                        </ul>
                    </div>
                </div>
                <div class="chat-item-time">{{ chat.updated_at.strftime('%Y-%m-%d %H:%M') }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Main chat area -->
    <div class="chat-main">
        <div class="chat-header d-flex justify-content-between align-items-center">
            <div>
                <button class="btn btn-sm btn-outline-secondary d-none toggle-sidebar" id="toggleSidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <span class="ms-2 fw-bold">{{ active_chat.title }}</span>
                <div class="d-inline-block model-switcher">
                    {% if current_model == 'deepseek' %}
                    <span class="model-badge model-badge-deepseek">DeepSeek</span>
                    {% elif current_model == 'siliconflow' %}
                    <span class="model-badge model-badge-siliconflow">硅谷流动</span>
                    {% elif current_model == 'custom' %}
                    <span class="model-badge model-badge-custom">{{ custom_model.display_name }}</span>
                    {% else %}
                    <span class="model-badge model-badge-openai">OpenAI</span>
                    {% endif %}
                    <button class="btn btn-sm btn-link text-muted model-switch-btn" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <ul class="dropdown-menu model-switch-menu">
                        <li><h6 class="dropdown-header">切换模型</h6></li>
                        <li><a class="dropdown-item {% if current_model == 'openai' %}active{% endif %}" href="#" data-model="openai">
                            <i class="fas fa-check me-2 {% if current_model != 'openai' %}invisible{% endif %}"></i>OpenAI
                        </a></li>
                        <li><a class="dropdown-item {% if current_model == 'deepseek' %}active{% endif %}" href="#" data-model="deepseek">
                            <i class="fas fa-check me-2 {% if current_model != 'deepseek' %}invisible{% endif %}"></i>DeepSeek
                        </a></li>
                        <li><a class="dropdown-item {% if current_model == 'siliconflow' %}active{% endif %}" href="#" data-model="siliconflow">
                            <i class="fas fa-check me-2 {% if current_model != 'siliconflow' %}invisible{% endif %}"></i>硅谷流动
                        </a></li>
                        
                        {% if custom_models %}
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">自定义模型</h6></li>
                        {% for model in custom_models %}
                        <li><a class="dropdown-item {% if current_model == 'custom' and custom_model_id == model.id|string %}active{% endif %}" href="#" data-model="custom" data-custom-model-id="{{ model.id }}">
                            <i class="fas fa-check me-2 {% if not (current_model == 'custom' and custom_model_id == model.id|string) %}invisible{% endif %}"></i>{{ model.display_name }}
                        </a></li>
                        {% endfor %}
                        {% endif %}
                    </ul>
                </div>
            </div>
            <div>
                <a href="{{ url_for('chat.settings') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-cog me-1"></i>设置
                </a>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            {% if messages %}
                {% for message in messages %}
                <div class="chat-bubble {% if message.role == 'user' %}user-message{% else %}assistant-message{% endif %}">
                    {{ message.content|safe }}
                    <div class="message-time">{{ message.created_at.strftime('%H:%M') }}</div>
                </div>
                {% endfor %}
            {% else %}
                <div class="chat-empty-state">
                    <i class="fas fa-robot"></i>
                    <h4>开始与豆包AI助手对话</h4>
                    <p>在下方输入框中输入您的问题，豆包AI助手将为您提供帮助。</p>
                    {% if current_model == 'deepseek' %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>当前使用的是 <strong>DeepSeek</strong> 中文大模型
                    </div>
                    {% elif current_model == 'siliconflow' %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>当前使用的是 <strong>硅谷流动</strong> 中文大模型
                    </div>
                    {% else %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>当前使用的是 <strong>OpenAI GPT-3.5</strong> 模型
                    </div>
                    {% endif %}
                </div>
            {% endif %}
            
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
                <div class="timeout-message" id="timeoutMessage">
                    模型响应较慢，请耐心等待...
                </div>
            </div>
        </div>
        
        <div class="chat-input">
            <form id="messageForm" data-chat-id="{{ active_chat.id }}">
                <div class="input-group">
                    <textarea class="form-control" id="messageInput" rows="1" placeholder="输入消息... (按Enter发送，Shift+Enter换行)" required></textarea>
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="form-text text-end small mt-1">
                    <span class="text-muted">按 Enter 发送 · Shift+Enter 换行 · 按 / 快速聚焦</span>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rename Chat Modal -->
<div class="modal fade" id="renameChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">重命名对话</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="renameChatForm">
                    <input type="hidden" id="renameChatId">
                    <div class="mb-3">
                        <label for="chatTitle" class="form-label">对话标题</label>
                        <input type="text" class="form-control" id="chatTitle" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveChatTitle">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Chat Confirmation Modal -->
<div class="modal fade" id="deleteChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">删除对话</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除这个对话吗？此操作无法撤销。</p>
                <form id="deleteChatForm">
                    <input type="hidden" id="deleteChatId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteChat">删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chatMessages');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const typingIndicator = document.getElementById('typingIndicator');
        const newChatBtn = document.getElementById('newChatBtn');
        const chatItems = document.querySelectorAll('.chat-item');
        const toggleSidebar = document.getElementById('toggleSidebar');
        const chatSidebar = document.getElementById('chatSidebar');
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // Handle keyboard shortcuts for sending messages
        messageInput.addEventListener('keydown', function(e) {
            // Enter key without Shift to send message
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent default behavior (new line)
                
                // Only submit if there's content
                if (this.value.trim()) {
                    // Flash the send button to provide visual feedback
                    const sendButton = messageForm.querySelector('button[type="submit"]');
                    sendButton.classList.add('send-button-flash', 'active');
                    
                    // Remove the animation class after animation completes
                    setTimeout(() => {
                        sendButton.classList.remove('send-button-flash', 'active');
                    }, 300);
                    
                    messageForm.dispatchEvent(new Event('submit'));
                }
            }
            // Shift+Enter for new line (default behavior, no need to handle)
        });
        
        // Scroll to bottom of chat
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            document.getElementById('timeoutMessage').style.display = 'none';
            scrollToBottom();
            
            // Show timeout message after 8 seconds if still loading
            typingTimeout = setTimeout(() => {
                if (typingIndicator.style.display === 'block') {
                    document.getElementById('timeoutMessage').style.display = 'inline';
                    scrollToBottom();
                }
            }, 8000);
        }
        
        // Hide typing indicator
        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
            document.getElementById('timeoutMessage').style.display = 'none';
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
        }
        
        // Format timestamp
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Preprocess AI response for better formatting
        function preprocessAIResponse(content) {
            // Ensure paragraphs are properly separated
            if (!content.includes('<p>') && !content.includes('<br>') && !content.includes('<div>')) {
                // Add proper paragraph breaks
                content = content.replace(/\n\s*\n/g, '\n\n');
                
                // Ensure code blocks are properly formatted
                content = content.replace(/```([^`]*?)```/gs, function(match) {
                    return match.replace(/\n/g, '<br>');
                });
            }
            return content;
        }
        
        // Render markdown formatting for messages
        function renderMarkdown() {
            const assistantMessages = document.querySelectorAll('.assistant-message');
            assistantMessages.forEach(message => {
                // Process code blocks
                let content = message.innerHTML;
                
                // Skip if already processed or contains HTML elements
                if (content.includes('<pre') || content.includes('<code>') || content.includes('<p>')) {
                    return;
                }
                
                // Replace line breaks with <br> tags
                content = content.replace(/\n/g, '<br>');
                
                // Format code blocks
                content = content.replace(/```(\w*)([\s\S]*?)```/g, function(match, language, code) {
                    return `<pre class="code-block"><code class="${language}">${code.trim()}</code></pre>`;
                });
                
                // Format inline code
                content = content.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
                
                // Format lists
                content = content.replace(/^\s*[-*]\s+(.+)$/gm, '<li>$1</li>');
                content = content.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
                
                // Format headings
                content = content.replace(/^###\s+(.+)$/gm, '<h5>$1</h5>');
                content = content.replace(/^##\s+(.+)$/gm, '<h4>$1</h4>');
                content = content.replace(/^#\s+(.+)$/gm, '<h3>$1</h3>');
                
                // Format bold and italic
                content = content.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                content = content.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                
                // Update the message content
                message.innerHTML = content;
            });
        }
        
        // Show error message in chat
        function showErrorMessage(error, errorType) {
            const errorBubble = document.createElement('div');
            errorBubble.className = 'alert alert-danger mt-3';
            
            // Get current model
            const currentModel = document.querySelector('.model-switch-menu .dropdown-item.active')?.getAttribute('data-model') || 'openai';
            
            let errorContent = `<i class="fas fa-exclamation-circle me-2"></i>${error}`;
            
            // Add specific guidance based on error type
            if (errorType === 'api_key_missing') {
                errorContent += `
                <div class="mt-2">
                    <a href="/chat/settings?model=${currentModel}#${currentModel}-section" class="btn btn-primary btn-sm">
                        <i class="fas fa-key me-1"></i>配置API密钥
                    </a>
                </div>`;
            } else if (errorType === 'api_timeout' || errorType === 'request_timeout') {
                errorContent += `
                <div class="mt-2">
                    <p class="small">模型响应时间过长，您可以：</p>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-sm model-switch-quick" data-model="openai">
                            <i class="fas fa-exchange-alt me-1"></i>切换到OpenAI
                        </button>
                        <button class="btn btn-outline-primary btn-sm retry-btn">
                            <i class="fas fa-redo me-1"></i>重试
                        </button>
                    </div>
                </div>`;
            } else if (errorType === 'api_connection_error') {
                errorContent += `
                <div class="mt-2">
                    <p class="small">请检查您的网络连接，然后重试</p>
                    <button class="btn btn-primary btn-sm retry-btn">
                        <i class="fas fa-redo me-1"></i>重试
                    </button>
                </div>`;
            } else if (errorType === 'api_call_failed' || error.includes('Authentication Fails') || error.includes('401')) {
                errorContent += `
                <div class="mt-2">
                    <p class="small">API密钥错误或已过期，请更新您的API密钥</p>
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="/chat/settings?model=${currentModel}#${currentModel}-section" class="btn btn-primary btn-sm">
                            <i class="fas fa-key me-1"></i>更新${currentModel === 'openai' ? 'OpenAI' : currentModel === 'deepseek' ? 'DeepSeek' : '硅谷流动'}密钥
                        </a>
                        <button class="btn btn-outline-primary btn-sm model-switch-quick" data-model="${currentModel === 'openai' ? 'deepseek' : 'openai'}">
                            <i class="fas fa-exchange-alt me-1"></i>切换到${currentModel === 'openai' ? 'DeepSeek' : 'OpenAI'}
                        </button>
                    </div>
                </div>`;
            } else if (errorType === 'api_authentication_error') {
                errorContent += `
                <div class="mt-2">
                    <p class="small">API认证失败，请检查并更新您的API密钥</p>
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="/chat/settings?model=${currentModel}#${currentModel}-section" class="btn btn-primary btn-sm">
                            <i class="fas fa-key me-1"></i>更新${currentModel === 'openai' ? 'OpenAI' : currentModel === 'deepseek' ? 'DeepSeek' : '硅谷流动'}密钥
                        </a>
                        <button class="btn btn-outline-primary btn-sm model-switch-quick" data-model="${currentModel === 'openai' ? 'deepseek' : 'openai'}">
                            <i class="fas fa-exchange-alt me-1"></i>切换到${currentModel === 'openai' ? 'DeepSeek' : 'OpenAI'}
                        </button>
                    </div>
                </div>`;
            }
            
            errorBubble.innerHTML = errorContent;
            chatMessages.appendChild(errorBubble);
            scrollToBottom();
            
            // Add event listener to retry button if it exists
            const retryBtn = errorBubble.querySelector('.retry-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    // Remove the error message
                    errorBubble.remove();
                    
                    // Resend the last message
                    const lastUserMessage = document.querySelector('.user-message:last-of-type');
                    if (lastUserMessage) {
                        const content = lastUserMessage.textContent.trim();
                        if (content) {
                            // Show typing indicator
                            showTypingIndicator();
                            scrollToBottom();
                            
                            // Resend the message
                            const chatId = messageForm.getAttribute('data-chat-id');
                            sendMessageToServer(chatId, content);
                        }
                    }
                });
            }
            
            // Add event listener to model switch buttons
            const modelSwitchBtns = errorBubble.querySelectorAll('.model-switch-quick');
            modelSwitchBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const model = this.getAttribute('data-model');
                    
                    // Show loading state
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>切换中...';
                    this.disabled = true;
                    
                    // Switch model
                    switchModel(model, () => {
                        // On success, remove the error message and retry
                        errorBubble.remove();
                        
                        // Resend the last message after a short delay to allow the model to switch
                        setTimeout(() => {
                            const lastUserMessage = document.querySelector('.user-message:last-of-type');
                            if (lastUserMessage) {
                                const content = lastUserMessage.textContent.trim();
                                if (content) {
                                    // Show typing indicator
                                    showTypingIndicator();
                                    scrollToBottom();
                                    
                                    // Resend the message
                                    const chatId = messageForm.getAttribute('data-chat-id');
                                    sendMessageToServer(chatId, content);
                                }
                            }
                        }, 500);
                    });
                });
            });
            
            // Auto-remove error message after 30 seconds
            setTimeout(() => {
                if (errorBubble.parentNode) {
                    errorBubble.remove();
                }
            }, 30000);
        }
        
        // Send message to server
        function sendMessageToServer(chatId, content) {
            // Set a timeout to abort the request if it takes too long
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            fetch(`/chat/${chatId}/message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    'content': content,
                    'csrf_token': '{{ csrf_token }}'
                }),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || '发送消息失败，请重试', { cause: data.error_type });
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide typing indicator
                hideTypingIndicator();
                
                if (data.success) {
                    // Add AI response to chat
                    const aiBubble = document.createElement('div');
                    aiBubble.className = 'chat-bubble assistant-message';
                    aiBubble.innerHTML = preprocessAIResponse(data.ai_message.content) + 
                        '<div class="message-time">' + formatTime(data.ai_message.created_at) + '</div>';
                    chatMessages.appendChild(aiBubble);
                    
                    // Apply Markdown formatting to the new message
                    renderMarkdown();
                    
                    scrollToBottom();
                    
                    // Update chat title if it's a new chat
                    const activeChatTitle = document.querySelector('.chat-header span');
                    if (activeChatTitle && activeChatTitle.textContent === '新对话') {
                        // Get the first chat item (which should be the current chat)
                        const firstChatItem = document.querySelector('.chat-item');
                        if (firstChatItem) {
                            const titleElement = firstChatItem.querySelector('.chat-item-title');
                            const title = content.substring(0, 20) + (content.length > 20 ? '...' : '');
                            titleElement.textContent = title;
                            activeChatTitle.textContent = title;
                        }
                    }
                } else {
                    showErrorMessage(data.error || '发送消息失败，请重试', data.error_type);
                }
            })
            .catch(error => {
                hideTypingIndicator();
                console.error('Error:', error);
                
                // Handle abort error specifically
                if (error.name === 'AbortError') {
                    showErrorMessage('请求超时，模型响应时间过长。请尝试使用其他模型或稍后重试。', 'request_timeout');
                } else {
                    // Check for authentication errors in the error message
                    if (error.message && (error.message.includes('Authentication Fails') || 
                                         error.message.includes('401') || 
                                         error.message.includes('认证失败'))) {
                        showErrorMessage('API认证失败：API密钥可能无效或已过期。请更新您的API密钥。', 'api_authentication_error');
                    } else {
                        showErrorMessage(error.message || '发送消息失败，请重试', error.cause);
                    }
                }
                
                clearTimeout(timeoutId);
            });
        }
        
        // Send message
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Check if there's an API error already displayed
            const existingApiError = document.querySelector('.alert-danger');
            if (existingApiError && (
                existingApiError.textContent.includes('API认证失败') || 
                existingApiError.textContent.includes('Authentication Fails') ||
                existingApiError.textContent.includes('API密钥错误')
            )) {
                // Remove the old error message
                existingApiError.remove();
                
                // Show a more direct message about fixing the API key first
                const warningBubble = document.createElement('div');
                warningBubble.className = 'alert alert-warning mt-3';
                warningBubble.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>请先更新API密钥</strong>
                    <p class="small mt-2">您需要先更新API密钥才能继续对话。</p>
                    <a href="/chat/settings" class="btn btn-warning btn-sm mt-2">
                        <i class="fas fa-key me-1"></i>前往设置页面
                    </a>
                `;
                chatMessages.appendChild(warningBubble);
                scrollToBottom();
                return;
            }
            
            const chatId = this.getAttribute('data-chat-id');
            
            // Add user message to chat
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble user-message';
            userBubble.innerHTML = message + '<div class="message-time">' + formatTime(new Date()) + '</div>';
            chatMessages.appendChild(userBubble);
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Show typing indicator
            showTypingIndicator();
            scrollToBottom();
            
            // Send message to server
            sendMessageToServer(chatId, message);
        });
        
        // Create new chat
        newChatBtn.addEventListener('click', function() {
            fetch('/chat/new', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    'csrf_token': '{{ csrf_token }}'
                })
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || '创建新对话失败，请重试');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showErrorMessage(error.message || '创建新对话失败，请重试', null);
            });
        });
        
        // Switch between chats
        chatItems.forEach(item => {
            item.addEventListener('click', function(e) {
                if (e.target.closest('.chat-options') || e.target.closest('.dropdown-menu')) {
                    return;
                }
                
                const chatId = this.getAttribute('data-chat-id');
                window.location.href = `/chat/?chat_id=${chatId}`;
            });
        });
        
        // Rename chat
        const renameChatModal = new bootstrap.Modal(document.getElementById('renameChatModal'));
        const renameChatLinks = document.querySelectorAll('.rename-chat');
        const renameChatForm = document.getElementById('renameChatForm');
        const renameChatId = document.getElementById('renameChatId');
        const chatTitle = document.getElementById('chatTitle');
        const saveChatTitle = document.getElementById('saveChatTitle');
        
        renameChatLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const chatId = this.getAttribute('data-chat-id');
                const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
                const currentTitle = chatItem.querySelector('.chat-item-title').textContent;
                
                renameChatId.value = chatId;
                chatTitle.value = currentTitle;
                renameChatModal.show();
            });
        });
        
        saveChatTitle.addEventListener('click', function() {
            if (!chatTitle.value.trim()) {
                alert('标题不能为空');
                return;
            }
            
            const chatId = renameChatId.value;
            
            fetch(`/chat/${chatId}/rename`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    'title': chatTitle.value.trim(),
                    'csrf_token': '{{ csrf_token }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
                    chatItem.querySelector('.chat-item-title').textContent = chatTitle.value.trim();
                    
                    // Update header title if this is the active chat
                    if (chatItem.classList.contains('active')) {
                        document.querySelector('.chat-header span').textContent = chatTitle.value.trim();
                    }
                    
                    renameChatModal.hide();
                } else {
                    alert('重命名失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('重命名失败，请重试');
            });
        });
        
        // Delete chat
        const deleteChatModal = new bootstrap.Modal(document.getElementById('deleteChatModal'));
        const deleteChatLinks = document.querySelectorAll('.delete-chat');
        const deleteChatId = document.getElementById('deleteChatId');
        const confirmDeleteChat = document.getElementById('confirmDeleteChat');
        
        deleteChatLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const chatId = this.getAttribute('data-chat-id');
                deleteChatId.value = chatId;
                deleteChatModal.show();
            });
        });
        
        confirmDeleteChat.addEventListener('click', function() {
            const chatId = deleteChatId.value;
            
            fetch(`/chat/${chatId}/delete`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    'csrf_token': '{{ csrf_token }}'
                })
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || '删除失败，请重试');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败，请重试: ' + error.message);
            });
        });
        
        // Mobile sidebar toggle
        if (toggleSidebar) {
            toggleSidebar.addEventListener('click', function() {
                chatSidebar.classList.toggle('show');
            });
        }
        
        // Check if we need to show the mobile sidebar toggle
        function checkMobileView() {
            if (window.innerWidth <= 768) {
                toggleSidebar.classList.remove('d-none');
            } else {
                toggleSidebar.classList.add('d-none');
                chatSidebar.classList.remove('show');
            }
        }
        
        // Initial check
        checkMobileView();
        
        // Check on resize
        window.addEventListener('resize', checkMobileView);
        
        // Initial scroll to bottom
        scrollToBottom();
        
        // Initial render of markdown
        renderMarkdown();
        
        // Handle model switching
        const modelSwitchItems = document.querySelectorAll('.model-switch-menu .dropdown-item');
        
        // Helper function to switch models
        function switchModel(model, callback, customModelId) {
            // Prepare request data
            const requestData = {
                'model': model,
                'csrf_token': '{{ csrf_token }}'
            };
            
            // Add custom model ID if provided
            if (model === 'custom' && customModelId) {
                requestData.custom_model_id = customModelId;
            }
            
            // Send request to update model
            fetch('/chat/switch_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams(requestData)
            })
            .then(response => {
                if (response.ok) {
                    if (callback) {
                        callback();
                    } else {
                        // Reload the page to apply the new model
                        window.location.reload();
                    }
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || '切换模型失败，请重试');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('切换模型失败: ' + error.message);
            });
        }
        
        modelSwitchItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                const model = this.getAttribute('data-model');
                const customModelId = this.getAttribute('data-custom-model-id');
                const currentModel = '{{ current_model }}';
                const currentCustomModelId = '{{ custom_model_id }}';
                
                // Don't do anything if clicking the current model
                if (model === currentModel && (!customModelId || customModelId === currentCustomModelId)) return;
                
                // Show confirmation dialog
                let modelName = '';
                if (model === 'openai') {
                    modelName = 'OpenAI';
                } else if (model === 'deepseek') {
                    modelName = 'DeepSeek';
                } else if (model === 'siliconflow') {
                    modelName = '硅谷流动';
                } else if (model === 'custom') {
                    modelName = this.textContent.trim();
                }
                
                if (confirm(`确定要切换到 ${modelName} 模型吗？`)) {
                    // Show loading state
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>' + this.textContent;
                    
                    // Switch model
                    switchModel(model, null, customModelId);
                }
            });
        });
        
        // Auto-focus the message input on page load
        setTimeout(() => {
            messageInput.focus();
        }, 500);
        
        // Global keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Slash key (/) to focus the message input, common in many chat apps
            if (e.key === '/' && document.activeElement !== messageInput) {
                // Only if not already in an input or textarea
                if (document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    messageInput.focus();
                }
            }
        });
    });
</script>
{% endblock %} 