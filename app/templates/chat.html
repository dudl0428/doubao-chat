{% extends "base.html" %}

{% block title %}聊天 - 豆包AI聊天{% endblock %}

{% block styles %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
    }
    
    .chat-sidebar {
        width: 280px;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
    }
    
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }
    
    .chat-input {
        padding: 15px;
        border-top: 1px solid #dee2e6;
    }
    
    .chat-bubble {
        max-width: 80%;
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 18px;
        position: relative;
    }
    
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 5px;
    }
    
    .assistant-message {
        background-color: #f1f1f1;
        color: #333;
        margin-right: auto;
        border-bottom-left-radius: 5px;
    }
    
    .chat-item {
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
    }
    
    .chat-item:hover {
        background-color: #f8f9fa;
    }
    
    .chat-item.active {
        background-color: #e9ecef;
    }
    
    .chat-item-title {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .chat-item-time {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .new-chat-btn {
        margin: 15px;
    }
    
    .message-time {
        font-size: 0.7rem;
        margin-top: 5px;
        opacity: 0.7;
    }
    
    .typing-indicator {
        display: none;
        padding: 10px 15px;
        background-color: #f1f1f1;
        border-radius: 18px;
        margin-bottom: 15px;
        width: fit-content;
    }
    
    .typing-indicator span {
        height: 10px;
        width: 10px;
        float: left;
        margin: 0 1px;
        background-color: #9E9EA1;
        display: block;
        border-radius: 50%;
        opacity: 0.4;
    }
    
    .typing-indicator span:nth-of-type(1) {
        animation: 1s blink infinite 0.3333s;
    }
    
    .typing-indicator span:nth-of-type(2) {
        animation: 1s blink infinite 0.6666s;
    }
    
    .typing-indicator span:nth-of-type(3) {
        animation: 1s blink infinite 0.9999s;
    }
    
    .typing-indicator .timeout-message {
        display: none;
        margin-left: 20px;
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    @keyframes blink {
        50% {
            opacity: 1;
        }
    }
    
    .chat-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
    }
    
    .chat-empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
        .chat-sidebar {
            width: 100%;
            position: fixed;
            top: 56px;
            left: 0;
            height: calc(100vh - 56px);
            z-index: 1000;
            background-color: white;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .chat-sidebar.show {
            transform: translateX(0);
        }
        
        .toggle-sidebar {
            display: block !important;
        }
    }
    
    .model-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        margin-left: 0.5rem;
    }
    
    .model-badge-openai {
        background-color: #10a37f;
        color: white;
    }
    
    .model-badge-deepseek {
        background-color: #4361ee;
        color: white;
    }
    
    .model-badge-siliconflow {
        background-color: #ff6b6b;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Sidebar with chat history -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="d-grid gap-2 new-chat-btn">
            <button class="btn btn-primary" id="newChatBtn">
                <i class="fas fa-plus me-2"></i>新对话
            </button>
        </div>
        
        <div class="chat-list">
            {% for chat in chats %}
            <div class="chat-item {% if chat.id == active_chat.id %}active{% endif %}" data-chat-id="{{ chat.id }}">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="chat-item-title">{{ chat.title }}</div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-link text-muted chat-options" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item rename-chat" href="#" data-chat-id="{{ chat.id }}">重命名</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-chat" href="#" data-chat-id="{{ chat.id }}">删除</a></li>
                        </ul>
                    </div>
                </div>
                <div class="chat-item-time">{{ chat.updated_at.strftime('%Y-%m-%d %H:%M') }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Main chat area -->
    <div class="chat-main">
        <div class="chat-header d-flex justify-content-between align-items-center">
            <div>
                <button class="btn btn-sm btn-outline-secondary d-none toggle-sidebar" id="toggleSidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <span class="ms-2 fw-bold">{{ active_chat.title }}</span>
                {% if current_model == 'deepseek' %}
                <span class="model-badge model-badge-deepseek">DeepSeek</span>
                {% elif current_model == 'siliconflow' %}
                <span class="model-badge model-badge-siliconflow">硅谷流动</span>
                {% else %}
                <span class="model-badge model-badge-openai">OpenAI</span>
                {% endif %}
            </div>
            <div>
                <a href="{{ url_for('chat.settings') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-cog me-1"></i>设置
                </a>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            {% if messages %}
                {% for message in messages %}
                <div class="chat-bubble {% if message.role == 'user' %}user-message{% else %}assistant-message{% endif %}">
                    {{ message.content|safe }}
                    <div class="message-time">{{ message.created_at.strftime('%H:%M') }}</div>
                </div>
                {% endfor %}
            {% else %}
                <div class="chat-empty-state">
                    <i class="fas fa-robot"></i>
                    <h4>开始与豆包AI助手对话</h4>
                    <p>在下方输入框中输入您的问题，豆包AI助手将为您提供帮助。</p>
                    {% if current_model == 'deepseek' %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>当前使用的是 <strong>DeepSeek</strong> 中文大模型
                    </div>
                    {% elif current_model == 'siliconflow' %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>当前使用的是 <strong>硅谷流动</strong> 中文大模型
                    </div>
                    {% else %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>当前使用的是 <strong>OpenAI GPT-3.5</strong> 模型
                    </div>
                    {% endif %}
                </div>
            {% endif %}
            
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
                <div class="timeout-message" id="timeoutMessage">
                    模型响应较慢，请耐心等待...
                </div>
            </div>
        </div>
        
        <div class="chat-input">
            <form id="messageForm" data-chat-id="{{ active_chat.id }}">
                <div class="input-group">
                    <textarea class="form-control" id="messageInput" rows="1" placeholder="输入消息..." required></textarea>
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rename Chat Modal -->
<div class="modal fade" id="renameChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">重命名对话</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="renameChatForm">
                    <input type="hidden" id="renameChatId">
                    <div class="mb-3">
                        <label for="chatTitle" class="form-label">对话标题</label>
                        <input type="text" class="form-control" id="chatTitle" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveChatTitle">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Chat Confirmation Modal -->
<div class="modal fade" id="deleteChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">删除对话</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除这个对话吗？此操作无法撤销。</p>
                <form id="deleteChatForm">
                    <input type="hidden" id="deleteChatId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteChat">删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chatMessages');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const typingIndicator = document.getElementById('typingIndicator');
        const newChatBtn = document.getElementById('newChatBtn');
        const chatItems = document.querySelectorAll('.chat-item');
        const toggleSidebar = document.getElementById('toggleSidebar');
        const chatSidebar = document.getElementById('chatSidebar');
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // Scroll to bottom of chat
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            document.getElementById('timeoutMessage').style.display = 'none';
            scrollToBottom();
            
            // Show timeout message after 8 seconds if still loading
            typingTimeout = setTimeout(() => {
                if (typingIndicator.style.display === 'block') {
                    document.getElementById('timeoutMessage').style.display = 'inline';
                    scrollToBottom();
                }
            }, 8000);
        }
        
        // Hide typing indicator
        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
            document.getElementById('timeoutMessage').style.display = 'none';
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
        }
        
        // Format timestamp
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Preprocess AI response for better formatting
        function preprocessAIResponse(content) {
            // Ensure paragraphs are properly separated
            if (!content.includes('<p>') && !content.includes('<br>') && !content.includes('<div>')) {
                // Add proper paragraph breaks
                content = content.replace(/\n\s*\n/g, '\n\n');
                
                // Ensure code blocks are properly formatted
                content = content.replace(/```([^`]*?)```/gs, function(match) {
                    return match.replace(/\n/g, '<br>');
                });
            }
            return content;
        }
        
        // Show error message in chat
        function showErrorMessage(error, errorType) {
            const errorBubble = document.createElement('div');
            errorBubble.className = 'alert alert-danger mt-3';
            
            let errorContent = `<i class="fas fa-exclamation-circle me-2"></i>${error}`;
            
            // Add specific guidance based on error type
            if (errorType === 'api_key_missing') {
                errorContent += `
                <div class="mt-2">
                    <a href="/chat/settings" class="btn btn-primary btn-sm">
                        <i class="fas fa-cog me-1"></i>前往设置页面配置API密钥
                    </a>
                </div>`;
            } else if (errorType === 'api_timeout') {
                errorContent += `
                <div class="mt-2">
                    <button class="btn btn-primary btn-sm retry-btn">
                        <i class="fas fa-redo me-1"></i>重试
                    </button>
                </div>`;
            } else if (errorType === 'api_connection_error') {
                errorContent += `
                <div class="mt-2">
                    <p class="small">请检查您的网络连接，然后重试</p>
                    <button class="btn btn-primary btn-sm retry-btn">
                        <i class="fas fa-redo me-1"></i>重试
                    </button>
                </div>`;
            } else if (errorType === 'api_call_failed') {
                errorContent += `
                <div class="mt-2">
                    <p class="small">可能是API密钥错误或服务器问题</p>
                    <a href="/chat/settings" class="btn btn-primary btn-sm me-2">
                        <i class="fas fa-cog me-1"></i>检查API设置
                    </a>
                    <button class="btn btn-outline-primary btn-sm retry-btn">
                        <i class="fas fa-redo me-1"></i>重试
                    </button>
                </div>`;
            }
            
            errorBubble.innerHTML = errorContent;
            chatMessages.appendChild(errorBubble);
            scrollToBottom();
            
            // Add event listener to retry button if it exists
            const retryBtn = errorBubble.querySelector('.retry-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    // Remove the error message
                    errorBubble.remove();
                    
                    // Resend the last message
                    const lastUserMessage = document.querySelector('.user-message:last-of-type');
                    if (lastUserMessage) {
                        const content = lastUserMessage.textContent.trim();
                        if (content) {
                            // Show typing indicator
                            showTypingIndicator();
                            scrollToBottom();
                            
                            // Resend the message
                            const chatId = messageForm.getAttribute('data-chat-id');
                            sendMessageToServer(chatId, content);
                        }
                    }
                });
            }
            
            // Auto-remove error message after 30 seconds
            setTimeout(() => {
                if (errorBubble.parentNode) {
                    errorBubble.remove();
                }
            }, 30000);
        }
        
        // Send message to server
        function sendMessageToServer(chatId, content) {
            // Set a timeout to abort the request if it takes too long
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            fetch(`/chat/${chatId}/message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    'content': content,
                    'csrf_token': '{{ csrf_token }}'
                }),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || '发送消息失败，请重试', { cause: data.error_type });
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide typing indicator
                hideTypingIndicator();
                
                if (data.success) {
                    // Add AI response to chat
                    const aiBubble = document.createElement('div');
                    aiBubble.className = 'chat-bubble assistant-message';
                    aiBubble.innerHTML = preprocessAIResponse(data.ai_message.content) + 
                        '<div class="message-time">' + formatTime(data.ai_message.created_at) + '</div>';
                    chatMessages.appendChild(aiBubble);
                    
                    // Apply Markdown formatting to the new message
                    renderMarkdown();
                    
                    scrollToBottom();
                    
                    // Update chat title if it's a new chat
                    const activeChatTitle = document.querySelector('.chat-header span');
                    if (activeChatTitle.textContent === '新对话') {
                        // Get the first chat item (which should be the current chat)
                        const firstChatItem = document.querySelector('.chat-item');
                        if (firstChatItem) {
                            const titleElement = firstChatItem.querySelector('.chat-item-title');
                            const title = content.substring(0, 20) + (content.length > 20 ? '...' : '');
                            titleElement.textContent = title;
                            activeChatTitle.textContent = title;
                        }
                    }
                } else {
                    showErrorMessage(data.error || '发送消息失败，请重试', data.error_type);
                }
            })
            .catch(error => {
                hideTypingIndicator();
                console.error('Error:', error);
                
                // Handle abort error specifically
                if (error.name === 'AbortError') {
                    showErrorMessage('请求超时，模型响应时间过长。请尝试使用其他模型或稍后重试。', 'request_timeout');
                } else {
                    showErrorMessage(error.message || '发送消息失败，请重试', error.cause);
                }
                
                clearTimeout(timeoutId);
            });
        }
        
        // Send message
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            const chatId = this.getAttribute('data-chat-id');
            
            // Add user message to chat
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble user-message';
            userBubble.innerHTML = message + '<div class="message-time">' + formatTime(new Date()) + '</div>';
            chatMessages.appendChild(userBubble);
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Show typing indicator
            showTypingIndicator();
            scrollToBottom();
            
            // Send message to server
            sendMessageToServer(chatId, message);
        });
        
        // Create new chat
        newChatBtn.addEventListener('click', function() {
            fetch('/chat/new', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    'csrf_token': '{{ csrf_token }}'
                })
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || '创建新对话失败，请重试');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showErrorMessage(error.message || '创建新对话失败，请重试', null);
            });
        });
        
        // Switch between chats
        chatItems.forEach(item => {
            item.addEventListener('click', function(e) {
                if (e.target.closest('.chat-options') || e.target.closest('.dropdown-menu')) {
                    return;
                }
                
                const chatId = this.getAttribute('data-chat-id');
                window.location.href = `/chat/?chat_id=${chatId}`;
            });
        });
        
        // Rename chat
        const renameChatModal = new bootstrap.Modal(document.getElementById('renameChatModal'));
        const renameChatLinks = document.querySelectorAll('.rename-chat');
        const renameChatForm = document.getElementById('renameChatForm');
        const renameChatId = document.getElementById('renameChatId');
        const chatTitle = document.getElementById('chatTitle');
        const saveChatTitle = document.getElementById('saveChatTitle');
        
        renameChatLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const chatId = this.getAttribute('data-chat-id');
                const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
                const currentTitle = chatItem.querySelector('.chat-item-title').textContent;
                
                renameChatId.value = chatId;
                chatTitle.value = currentTitle;
                renameChatModal.show();
            });
        });
        
        saveChatTitle.addEventListener('click', function() {
            if (!chatTitle.value.trim()) {
                alert('标题不能为空');
                return;
            }
            
            const chatId = renameChatId.value;
            
            fetch(`/chat/${chatId}/rename`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    'title': chatTitle.value.trim(),
                    'csrf_token': '{{ csrf_token }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
                    chatItem.querySelector('.chat-item-title').textContent = chatTitle.value.trim();
                    
                    // Update header title if this is the active chat
                    if (chatItem.classList.contains('active')) {
                        document.querySelector('.chat-header span').textContent = chatTitle.value.trim();
                    }
                    
                    renameChatModal.hide();
                } else {
                    alert('重命名失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('重命名失败，请重试');
            });
        });
        
        // Delete chat
        const deleteChatModal = new bootstrap.Modal(document.getElementById('deleteChatModal'));
        const deleteChatLinks = document.querySelectorAll('.delete-chat');
        const deleteChatId = document.getElementById('deleteChatId');
        const confirmDeleteChat = document.getElementById('confirmDeleteChat');
        
        deleteChatLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const chatId = this.getAttribute('data-chat-id');
                deleteChatId.value = chatId;
                deleteChatModal.show();
            });
        });
        
        confirmDeleteChat.addEventListener('click', function() {
            const chatId = deleteChatId.value;
            
            fetch(`/chat/${chatId}/delete`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    'csrf_token': '{{ csrf_token }}'
                })
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || '删除失败，请重试');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败，请重试: ' + error.message);
            });
        });
        
        // Mobile sidebar toggle
        if (toggleSidebar) {
            toggleSidebar.addEventListener('click', function() {
                chatSidebar.classList.toggle('show');
            });
        }
        
        // Check if we need to show the mobile sidebar toggle
        function checkMobileView() {
            if (window.innerWidth <= 768) {
                toggleSidebar.classList.remove('d-none');
            } else {
                toggleSidebar.classList.add('d-none');
                chatSidebar.classList.remove('show');
            }
        }
        
        // Initial check
        checkMobileView();
        
        // Check on resize
        window.addEventListener('resize', checkMobileView);
        
        // Initial scroll to bottom
        scrollToBottom();
        
        // Initial render of markdown
        renderMarkdown();
    });
</script>
{% endblock %} 